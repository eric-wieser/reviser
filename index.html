<html>
<body>
  <div id="document-wrapper"></div>
  <div id="question-wrapper"></div>

  <!-- Use latest PDF.js build from Github -->
  <script type="text/javascript" src="https://rawgithub.com/mozilla/pdf.js/gh-pages/build/pdf.js"></script>
  <script type="text/javascript" src="sugar.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-git2.js"></script>

  <style>
  body {
    margin: 0;
    padding: 0;
  }
  #document-wrapper {
    height: 100vh;
    width: 50vw;
    background: gray;
    overflow-y: scroll;
    position: absolute;
    left: 0;
  }
  #question-wrapper {
    height: 100vh;
    width: 50vw;
    background: #808080;
    overflow-y: scroll;
    position: absolute;
    right: 0;
  }
  .page {
    margin: 10px;
    box-shadow: 0 0 5px black;
    border: 1px solid #808080;
    float: left;
    position: relative;
  }
  .page canvas {
    display: block;
    max-width: 100%;
  }
  #document-wrapper .page .highlight {
    display: block;
    background: rgba(0, 128, 255, 0.5);
    border-top: 1px solid rgb(0, 128, 255);
    border-bottom: 1px solid rgb(0, 128, 255);
    position: absolute;
    left: 0;
    right: 0;
  }
  </style>

  <script type="text/javascript">

    //
    // NOTE:
    // Modifying the URL below to another server will likely *NOT* work. Because of browser
    // security restrictions, we have to use a file server with special headers
    // (CORS) - most servers don't support cross-origin browser requests.
    //
    var url = 'P1A2004Q004.pdf';

    //
    // Disable workers to avoid yet another cross-origin issue (workers need the URL of
    // the script to be loaded, and dynamically loading a cross-origin script does
    // not work)
    //
    PDFJS.disableWorker = true;


    var docWrap = $('#document-wrapper');
    var questWrap = $('#question-wrapper');

    var $highlight = $('<div>').addClass('highlight');
    function redrawHighlight() {
      var y1 = $highlight.data('y1');
      var y2 = $highlight.data('y2');
      var y = Math.min(y1, y2);
      var h = Math.abs(y2 - y1);
      $highlight.css('top', y + 'px');
      $highlight.css('height', h + 'px');
    }

    function eventRelY(e, elem) {
      var box = elem.getBoundingClientRect();
      return e.pageY - box.top;
    }

    function addHandlers(page) {
      page
      .on('mousedown', function(e) {
        $highlight.data('y1', eventRelY(e, this));
        $highlight.data('y2', eventRelY(e, this));
        redrawHighlight();
        $(this).append($highlight);
        return false;
      })
      .on('mousemove', function(e) {
        $highlight.data('y2', eventRelY(e, this));
        redrawHighlight();
      })
      .on('mouseup', function(e) {
        $highlight.data('y2', eventRelY(e, this));
        redrawHighlight();
        $highlight = $highlight.clone();
        return false;
      })
      .on('mouseleave', function(e) {
        $highlight.detach();
      });

      page.on('mousedown', '.highlight', function() {
        applyHighlight(page, this);
        $highlight.detach();
        return false;
      });
    }

    function pixelInteresting(imageData, x, y) {
      var pixels = imageData.data;
      var i = (y * imageData.width + x) * 4;
      if(pixels[i] < 225 || pixels[i+1] < 225 || pixels[i+2] < 225) {
        return true;
      }
    }


    // returns the first non-white row index of an image
    function rowInteresting(imageData, y) {
      for(var x = 0; x < imageData.width; x++)
        if(pixelInteresting(imageData, x, y))
          return true;
      return false;
    }

    // returns the first non-white row index of an image
    function firstInterestingRow(imageData) {
      for(var y = 0; y < imageData.height; y++)
        if(rowInteresting(imageData, y))
          return y;
      return null;
    }

    // returns the last non-white row index of an image
    function lastInterestingRow(imageData) {
      for(var y = imageData.height - 1; y >= 0; y--)
        if(rowInteresting(imageData, y))
          return y;
      return null;
    }

    function applyHighlight(pageElem, h) {
      var page = pageElem.data('page');
      console.log(page);


      var fullVP = page.getViewport(1);

      // get screen coordinates
      var y1 = $(h).data('y1');
      var y2 = $(h).data('y2');

      // convert to canvas coordinates
      var oldc = pageElem.find('canvas');
      y1 *= oldc[0].height / oldc.height();
      y2 *= oldc[0].height / oldc.height();

      // sort
      if(y1 > y2) {
        var temp = y1;
        y1 = y2;
        y2 = temp;
      }

      // now trim surrounding whitespace
      var imageData = oldc[0].getContext('2d').getImageData(0, y1, oldc[0].width, y2 - y1);
      var lir = lastInterestingRow(imageData);
      var fir = firstInterestingRow(imageData);
      if(lir == null || fir == null) {
        alert("Empty selection");
        h.remove();
        return;
      }
      y2 = y1 + lir;
      y1 = y1 + fir;

      // convert to pdf coordinates
      y1 = fullVP.convertToPdfPoint(0, y1)[1];
      y2 = fullVP.convertToPdfPoint(0, y2)[1];

      // sort
      if(y1 > y2) {
        var temp = y1;
        y1 = y2;
        y2 = temp;
      }

      console.log(y1, y2);

      var c, p;
      questWrap.append(
        p = $('<div>').addClass('page').append(
          c = $('<canvas>')
        )
      );

      var canvas = c[0];
      var context = canvas.getContext('2d');

      var newVP = new PDFJS.PageViewport(
        /* viewBox  */ [
          fullVP.viewBox[0],
          Math.min(y1, y2),
          fullVP.viewBox[2],
          Math.max(y1, y2),
        ],
        /* scale    */ 1,
        /* rotation */ 0,
        /* offset   */ 0, 0
      )

      //
      // Prepare canvas using PDF page dimensions
      //
      canvas.height = newVP.height;
      canvas.width = newVP.width;

      //
      // Render PDF page into canvas context
      //
      return page.render({canvasContext: context, viewport: newVP});
    }


    //
    // Asynchronous download PDF as an ArrayBuffer
    //
    PDFJS.getDocument(url).then(function getPdf(pdf) {

      var dr = $('#document-wrapper');
      Number.range(1, pdf.numPages).every().map(function(i) {

        var c, p;
        dr.append(
          p = $('<div>').addClass('page').append(
            c = $('<canvas>')
          )
        );



        var canvas = c[0];
        var context = canvas.getContext('2d');

        return pdf.getPage(i).then(function getPage(page) {
          p.data('page', page);
          var fullVP = page.getViewport(1);

          var newVP = new PDFJS.PageViewport(
            /* viewBox  */ [
              fullVP.viewBox[0],
              fullVP.viewBox[3] / 2,
              fullVP.viewBox[2],
              fullVP.viewBox[3]
            ],
            /* scale    */ 1,
            /* rotation */ 0,
            /* offset   */ 0, 0
          )

          addHandlers(p);

          //
          // Prepare canvas using PDF page dimensions
          //
          canvas.height = fullVP.height;
          canvas.width = fullVP.width;

          //
          // Render PDF page into canvas context
          //
          return page.render({canvasContext: context, viewport: fullVP});
        });
      });
    });
  </script>
</body>
</html>
